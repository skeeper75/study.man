# 후니프린팅 인쇄자동견적 시스템 — 시스템 아키텍처

> **버전**: v1.0 | **작성일**: 2026-03-01
> **참고 문서**: ref/huni/260225_후니프린팅_인쇄자동주문견적시스템설계문서.md

---

## 1. 전체 시스템 아키텍처

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    후니프린팅 인쇄자동견적 시스템 전체 구성                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  [ 고객 접점 레이어 ]                                                       │
│  ┌──────────────────────┐  ┌───────────────────────────────────────┐    │
│  │   Shopby 쇼핑몰       │  │     후니프린팅 Admin Console             │    │
│  │  (Enterprise 플랫폼)  │  │     (Next.js + Shadcn/ui + Tailwind)  │    │
│  │  ┌────────────────┐  │  │                                       │    │
│  │  │  위젯빌더 (신규)│  │  │  상품관리 │ 가격설정 │ 제약조건빌더    │    │
│  │  │  인쇄옵션 선택  │  │  │  MES매핑 │ 주문조회 │ 자동견적 테스트 │    │
│  │  │  자동견적 표시  │  │  │                                       │    │
│  │  │  주문방식 선택  │  │  └───────────────────────────────────────┘    │
│  │  └────────────────┘  │                                              │
│  └──────────────────────┘                                              │
│          │                                                              │
│  ┌───────▼──────────────────────────────────────────────────────────┐  │
│  │                주문 방식 (2가지)                                     │  │
│  │  ┌─────────────────────────┐  ┌────────────────────────────────┐  │  │
│  │  │     PDF 파일 주문         │  │      Edicus 에디터 주문           │  │  │
│  │  │  고객이 인쇄 파일 직접 업로드│  │  온라인에서 직접 디자인 후 주문    │  │  │
│  │  │  PDF, AI, 고해상도 JPEG   │  │  Edicus JS SDK v2 (MotionOne)   │  │  │
│  │  └─────────────────────────┘  └────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│          │                                                               │
│  ┌───────▼──────────────────────────────────────────────────────────┐   │
│  │                  후니프린팅 자체 API Layer                            │   │
│  │                  (Next.js API Routes + Railway)                     │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  ┌──────────┐  │   │
│  │  │  자동견적 엔진 │  │  Shopby 연동 │  │ Edicus 연동│  │ MES 연동 │  │   │
│  │  │ json-rules  │  │  Webhook 수신│  │  JS SDK 래핑│  │ REST API │  │   │
│  │  │ -engine     │  │  API 호출    │  │  파일 전달   │  │  호출    │  │   │
│  │  └─────────────┘  └─────────────┘  └────────────┘  └──────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│          │                                                               │
│  ┌───────▼──────────────────────────────────────────────────────────┐   │
│  │              데이터베이스 (Neon PostgreSQL)                           │   │
│  │  tb_product_master  |  tb_product_option  |  tb_print_cost_base   │   │
│  │  tb_option_constraint  |  tb_addon_group  |  tb_order             │   │
│  │  tb_mes_mapping  |  tb_qty_discount  |  tb_postprocess_cost       │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│          │                                                               │
│  ┌───────▼──────────────────────────────────────────────────────────┐   │
│  │                    외부 시스템 연동                                    │   │
│  │  ┌────────────┐  ┌────────────┐  ┌──────────────┐  ┌──────────┐  │   │
│  │  │   Shopby   │  │   Edicus   │  │ MES (CRT)    │  │ 비즈하우스 │  │   │
│  │  │ Enterprise │  │ Cloud 에디터│  │ .NET WebAPI  │  │ (합판)   │  │   │
│  │  │ (판매/주문) │  │ MotionOne  │  │ api.huniprint│  │ (연동방식 │  │   │
│  │  │            │  │ SDK        │  │ ing.com      │  │  확인 필요)│  │   │
│  │  └────────────┘  └────────────┘  └──────────────┘  └──────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 전체 주문 흐름 (Mermaid)

```mermaid
flowchart TD
    A([고객]) --> B[Shopby 쇼핑몰 접속]
    B --> C[인쇄 상품 선택]
    C --> D[위젯빌더 - 옵션 선택]

    D --> E{주문 방식 선택}
    E --> F[PDF 파일 업로드]
    E --> G[Edicus 에디터 실행]

    F --> H[파일 검증]
    G --> I[온라인 디자인 편집]
    I --> J[Edicus 파일 저장]

    H --> K[장바구니 담기]
    J --> K

    K --> L[Shopby 결제 진행]
    L --> M{결제 완료}

    M -->|성공| N[후니프린팅 API - 주문 수신]
    M -->|실패| O[결제 실패 안내]

    N --> P[주문 데이터 DB 저장]
    P --> Q[MES API 호출]
    Q --> R[생산 지시서 생성]
    R --> S([MES 생산 시작])

    N --> T[관리자 콘솔 주문 확인]
    T --> U{검수 필요 여부}
    U -->|PDF 검수 필요| V[파일 검수]
    U -->|자동 진행| S
    V --> S
```

---

## 3. 자동견적 계산 흐름 (Mermaid)

```mermaid
flowchart LR
    A[고객 옵션 선택] --> B[위젯빌더 이벤트]
    B --> C[후니프린팅 API<br/>견적 계산 요청]

    C --> D[상품 마스터 조회<br/>tb_product_master]
    D --> E[제약조건 평가<br/>json-rules-engine]

    E --> F{제약 발동?}
    F -->|옵션 필터링| G[옵션 목록 갱신]
    F -->|추가상품 표시| H[addon 목록 표시]
    F -->|없음| I[가격 계산 실행]

    G --> I
    H --> I

    I --> J[출력비 계산<br/>tb_print_cost_base]
    J --> K[용지비 계산<br/>tb_paper_cost]
    K --> L[후가공비 계산<br/>tb_postprocess_cost]
    L --> M[박/형압비 계산<br/>tb_emboss_cost]
    M --> N[합계 산출]

    N --> O[견적 결과 반환]
    O --> P[위젯빌더 가격 표시]
```

---

## 4. 관리자 상품 설정 흐름 (Mermaid)

```mermaid
flowchart TD
    START([관리자 상품 설정 시작]) --> S1

    S1["① 상품 마스터 등록<br/>tb_product_master<br/>MES코드 · Shopby 코드 · Edicus 코드"]
    S1 --> S2

    S2["② 주문옵션 정의<br/>tb_product_option<br/>사이즈 · 인쇄 · 용지 · 가공 · 수량"]
    S2 --> S3

    S3["③ 가격룰 설정<br/>tb_print_cost_base<br/>tb_postprocess_cost<br/>tb_qty_discount"]
    S3 --> FORK{가격 계산 방식}

    FORK -->|수량별 단가표| QTY["수량 구간별 단가 입력"]
    FORK -->|면적 계산| AREA["면적 × 단가 방식 설정"]
    FORK -->|고정단가| FIXED["상품별 고정 단가 설정"]

    QTY --> S4
    AREA --> S4
    FIXED --> S4

    S4["④ 제약조건 등록<br/>tb_option_constraint<br/>IF-THEN 규칙 빌더"]
    S4 --> S5

    S5["⑤ 자동견적 시뮬레이션<br/>옵션 선택 → 가격 확인<br/>제약조건 동작 확인"]
    S5 --> OK{검수 통과?}

    OK -->|수정 필요| S2
    OK -->|통과| S6

    S6["⑥ Shopby 상품 연동 발행<br/>위젯빌더에 상품 활성화"]
    S6 --> END([설정 완료])
```

---

## 5. MES 연동 상세 흐름 (Mermaid)

```mermaid
sequenceDiagram
    participant 고객
    participant Shopby
    participant 후니API
    participant DB
    participant MES

    고객->>Shopby: 결제 완료
    Shopby->>후니API: Webhook 전송 (주문 이벤트)
    후니API->>DB: 주문 데이터 저장
    DB-->>후니API: 저장 완료

    후니API->>DB: MES 매핑 조회<br/>(huniCode + 수량구간 → mesCode)
    DB-->>후니API: mesCode + processRoute

    후니API->>MES: POST /api/integration/shopby/webhook
    Note over 후니API,MES: { orderCode, mesCode, qty,<br/>fileUrl, customerInfo }

    MES->>MES: 생산 지시서 생성
    MES-->>후니API: 생산 접수 확인 (202 Accepted)
    후니API->>DB: 주문 상태 업데이트 (MES_SUBMITTED)
    후니API-->>Shopby: 주문 확인 응답
    Shopby-->>고객: 주문 완료 알림
```

---

## 6. Edicus 에디터 연동 흐름 (Mermaid)

```mermaid
sequenceDiagram
    participant 고객
    participant 위젯빌더
    participant 후니API
    participant Edicus

    고객->>위젯빌더: Edicus 에디터로 주문 선택
    위젯빌더->>후니API: 에디터 세션 요청<br/>(ps_code, template_uri)

    후니API->>Edicus: POST /context/create<br/>(API Key, partner, projectData)
    Edicus-->>후니API: contextId 반환

    후니API-->>위젯빌더: contextId + 에디터 URL
    위젯빌더->>고객: Edicus 에디터 iframe 열기

    고객->>Edicus: 디자인 편집
    고객->>Edicus: 편집 완료 (주문 버튼)
    Edicus->>후니API: 주문 완료 콜백<br/>(contextId, fileId)

    후니API->>Edicus: 인쇄 파일 정보 조회
    Edicus-->>후니API: 파일 URL (인쇄용 PDF)

    후니API->>위젯빌더: 주문 진행 가능 신호
    위젯빌더->>Shopby: 장바구니 담기 (파일 URL 포함)
```

---

## 7. 배포 아키텍처

```
┌──────────────────────────────────────────────────────┐
│                     Vercel (Frontend)                  │
│  ┌──────────────────┐    ┌──────────────────────────┐ │
│  │  Admin Console    │    │  위젯빌더 (빌드 결과물)     │ │
│  │  Next.js App      │    │  JS/CSS 번들              │ │
│  └──────────────────┘    └──────────────────────────┘ │
└──────────────────────────────────────────────────────┘
         │                           │
         ▼                           ▼
┌──────────────────────────────────────────────────────┐
│                    Railway (API Server)               │
│  ┌──────────────────────────────────────────────────┐ │
│  │         Next.js API Routes / Node.js              │ │
│  │  /api/quote    /api/products    /api/orders       │ │
│  │  /api/shopby   /api/edicus      /api/mes          │ │
│  └──────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────┐
│                  Neon PostgreSQL (DB)                  │
│           Serverless PostgreSQL (자동 스케일링)          │
└──────────────────────────────────────────────────────┘
         │                    │
         ▼                    ▼
┌──────────────┐    ┌──────────────────────────────────┐
│ Shopby API   │    │ api.huniprinting.com (MES)        │
│ (Enterprise) │    │ .NET WebAPI (기존 시스템)           │
└──────────────┘    └──────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────┐
│    api-dot-edicusbase.appspot.com (Edicus)            │
│    MotionOne 클라우드 에디터 서비스                     │
└──────────────────────────────────────────────────────┘
```

---

## 8. 기술 스택 상세

| 영역 | 기술 | 선택 이유 |
|------|------|----------|
| **Admin Frontend** | Next.js 14 App Router | SSR, API Routes 통합, Vercel 최적화 |
| **UI 컴포넌트** | Shadcn/ui + TailwindCSS | 빠른 개발, 커스터마이징 용이 |
| **위젯빌더** | Vanilla JS / React 18 | Shopby 스킨 호환성 |
| **API 서버** | Next.js API Routes | 단일 레포, 풀스택 구성 |
| **데이터베이스** | Neon PostgreSQL (JSONB) | 서버리스, 규칙 엔진 JSONB 저장 |
| **규칙 엔진** | json-rules-engine | IF-THEN 제약조건 평가 |
| **규칙 빌더 UI** | react-querybuilder | 노코드 규칙 편집기 |
| **배포 (Frontend)** | Vercel | Next.js 최적화 배포 |
| **배포 (API)** | Railway | 컨테이너 기반 API 서버 |
| **외부 에디터** | Edicus JS SDK v2 | MotionOne 파트너 계약 |

---

## 9. 베스트 프랙티스 적용 기준

본 시스템은 **헤드리스 커머스 아키텍처** 패턴을 적용합니다.

### CPQ (Configure-Price-Quote) 패턴
- Salesforce Revenue Cloud의 Conditional Logic Constraint 방식 차용
- IF-THEN ECA(Event-Condition-Action) 패턴으로 인쇄 제약조건 구현
- JSONB 기반 규칙 저장 → 배포 없이 관리자가 직접 규칙 변경 가능

### 데이터 설계 원칙
- 규칙과 데이터의 분리 (Rule-based, 하드코딩 금지)
- JSONB 컬럼으로 유연한 확장성 확보
- MES 연동을 위한 huniCode ↔ mesCode 매핑 테이블 관리

### API 설계
- RESTful API 원칙 준수
- Webhook 기반 이벤트 처리 (Shopby → 후니API)
- JWT 인증 (MES API 연동)
